<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinevent Logger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.3s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; max-width: 95%; width: 600px; }
        .input-field { width: 100%; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.75rem; }
        .tab-button { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; cursor: pointer; border: 2px solid transparent; }
        .tab-button.active { color: #007bff; border-color: #007bff; background-color: #e7f3ff; }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Main App Content -->
    <div id="app" class="max-w-7xl mx-auto space-y-8 hidden">
        <header class="card p-6 text-center">
            <h1 class="text-3xl font-bold text-gray-800">Kinevent Logger</h1>
            <p class="text-gray-600 mt-2">Analizá la pantalla del ventilador y gestioná los datos de tus pacientes.</p>
        </header>

        <!-- Step 1: Image Upload -->
        <div class="card p-6">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Paso 1: Cargar Foto del Ventilador</h2>
            <div class="flex flex-col items-center">
                <input type="file" id="imageUpload" accept="image/*" class="hidden">
                <button id="uploadButton" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                    Seleccionar Foto
                </button>
                <div id="imagePreviewContainer" class="mt-4 hidden"><img id="imagePreview" class="max-w-xs max-h-64 rounded-lg shadow-md" alt="Vista previa"></div>
            </div>
        </div>

        <!-- Step 2: Review Extracted Data -->
        <div id="analysisSection" class="card p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Paso 2: Datos Extraídos</h2>
            <div id="loader" class="flex justify-center items-center py-8 hidden"><div class="loader"></div><p class="ml-4 text-gray-600">Analizando imagen con IA...</p></div>
            
            <div id="analysisResult" class="hidden">
                <!-- Tabs -->
                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex space-x-4" aria-label="Tabs">
                        <button id="tabEvo" class="tab-button active">Para la Evolución (Copiar y Pegar)</button>
                        <button id="tabDb" class="tab-button">Para Base de Datos (Revisar y Guardar)</button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div id="contentEvo" class="">
                    <h3 class="font-semibold text-lg mb-2">Texto para la Evolución Clínica</h3>
                    <p class="text-sm text-gray-500 mb-2">Hacé clic en el texto para copiarlo al portapapeles.</p>
                    <textarea id="evolutionCopyArea" readonly class="w-full h-48 p-3 font-mono text-sm bg-gray-100 rounded-md border border-gray-300 cursor-pointer focus:ring-2 focus:ring-blue-500"></textarea>
                    <p id="copyFeedback" class="text-sm text-green-600 mt-2 h-4"></p>
                </div>

                <div id="contentDb" class="hidden">
                    <h3 class="font-semibold text-lg mb-2">Revisar Datos para Guardar</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><h4 class="font-semibold text-indigo-700 mb-2">Parámetros Programados</h4><div id="programmedParams" class="space-y-2"></div></div>
                        <div><h4 class="font-semibold text-teal-700 mb-2">Parámetros del Paciente</h4><div id="patientParams" class="space-y-2"></div></div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button id="saveButton" class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6a1 1 0 10-2 0v5.586L7.707 10.293zM5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5z" /></svg>
                            Guardar en Base de Datos
                        </button>
                    </div>
                </div>
            </div>
             <div id="analysisError" class="hidden text-center text-red-600 bg-red-100 p-4 rounded-md"><p>No se pudieron extraer los datos. Intentá con una imagen más clara.</p></div>
        </div>

        <!-- Step 3: Collaborative Database -->
        <div class="card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Base de Datos de Investigación</h2>
                <button id="exportCsvButton" class="btn btn-secondary">Exportar a CSV</button>
            </div>
            <div id="dbLoader" class="flex justify-center items-center py-8"><div class="loader"></div><p class="ml-4 text-gray-600">Cargando base de datos...</p></div>
            <div id="dbContent" class="overflow-x-auto hidden">
                <table class="min-w-full bg-white"><thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modo</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Programado</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paciente</th><th class="p-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th></tr></thead><tbody id="dataTableBody" class="bg-white divide-y divide-gray-200"></tbody></table>
                <p id="noDataMessage" class="text-center text-gray-500 py-8 hidden">Aún no hay datos.</p>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div id="setupModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Configuración Inicial</h2>
            <p class="text-gray-600 mb-6">Para usar la base de datos colaborativa, necesitás conectar la app a un proyecto de Firebase.</p>
            <div>
                <label for="firebaseConfigInput" class="font-semibold text-gray-700">Configuración de Firebase</label>
                <p class="text-sm text-gray-500 mb-1">Creá un proyecto en <a href="https://firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">Firebase</a>, activá Firestore y Authentication (Anónimo), y pegá aquí el objeto de configuración.</p>
                <textarea id="firebaseConfigInput" rows="8" class="input-field font-mono text-sm" placeholder="Pegá el objeto de configuración de Firebase aquí..."></textarea>
            </div>
            <div id="configError" class="text-red-600 mt-4 hidden"></div>
            <div class="mt-6 flex justify-end">
                <button id="saveConfigButton" class="btn btn-primary">Guardar y Empezar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, deleteDoc, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES ---
        let db, auth, userId;
        let extractedData = null;
        let allDbData = [];
        const APP_ID = 'kinevent-logger'; // UPDATED: Project Name

        // --- UI ELEMENTS ---
        const ui = {
            app: document.getElementById('app'),
            setupModal: document.getElementById('setupModal'),
            firebaseConfigInput: document.getElementById('firebaseConfigInput'),
            saveConfigButton: document.getElementById('saveConfigButton'),
            configError: document.getElementById('configError'),
            uploadButton: document.getElementById('uploadButton'),
            imageUpload: document.getElementById('imageUpload'),
            imagePreviewContainer: document.getElementById('imagePreviewContainer'),
            imagePreview: document.getElementById('imagePreview'),
            analysisSection: document.getElementById('analysisSection'),
            loader: document.getElementById('loader'),
            analysisResult: document.getElementById('analysisResult'),
            analysisError: document.getElementById('analysisError'),
            tabEvo: document.getElementById('tabEvo'),
            tabDb: document.getElementById('tabDb'),
            contentEvo: document.getElementById('contentEvo'),
            contentDb: document.getElementById('contentDb'),
            evolutionCopyArea: document.getElementById('evolutionCopyArea'),
            copyFeedback: document.getElementById('copyFeedback'),
            programmedParams: document.getElementById('programmedParams'),
            patientParams: document.getElementById('patientParams'),
            saveButton: document.getElementById('saveButton'),
            dbLoader: document.getElementById('dbLoader'),
            dbContent: document.getElementById('dbContent'),
            dataTableBody: document.getElementById('dataTableBody'),
            noDataMessage: document.getElementById('noDataMessage'),
            exportCsvButton: document.getElementById('exportCsvButton'),
        };

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }

        // --- CONFIGURATION & INITIALIZATION ---
        function checkConfig() {
            const storedConfig = localStorage.getItem('ventilatorFirebaseConfig');
            if (storedConfig) {
                try {
                    initApp(JSON.parse(storedConfig));
                } catch (e) {
                    showSetupModal();
                }
            } else {
                showSetupModal();
            }
        }

        function showSetupModal() {
            ui.setupModal.classList.remove('hidden');
            ui.firebaseConfigInput.value = localStorage.getItem('ventilatorFirebaseConfig') || '';
        }

        function saveConfig() {
            const configValue = ui.firebaseConfigInput.value.trim();
            try {
                const parsedConfig = JSON.parse(configValue);
                if (!parsedConfig.apiKey || !parsedConfig.projectId) throw new Error("Configuración incompleta.");
                localStorage.setItem('ventilatorFirebaseConfig', configValue);
                initApp(parsedConfig);
            } catch (e) {
                ui.configError.textContent = 'Formato de configuración de Firebase inválido.';
                ui.configError.classList.remove('hidden');
            }
        }

        function initApp(firebaseConfig) {
            ui.setupModal.classList.add('hidden');
            ui.app.classList.remove('hidden');
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        setupRealtimeListener();
                    } else {
                        signInAnonymously(auth);
                    }
                });
            } catch (error) {
                showSetupModal();
                ui.configError.textContent = `Error de Firebase: ${error.message}`;
                ui.configError.classList.remove('hidden');
            }
        }

        // --- DATABASE & REALTIME LISTENER ---
        function setupRealtimeListener() {
            const dataCollection = collection(db, `artifacts/${APP_ID}/public/data/readings`);
            onSnapshot(dataCollection, snapshot => {
                ui.dbLoader.classList.add('hidden');
                ui.dbContent.classList.remove('hidden');
                allDbData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allDbData.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderDataTable(allDbData);
            }, error => {
                console.error("Error de Firestore:", error);
                ui.dbLoader.textContent = "Error al cargar datos.";
            });
        }

        // --- UI RENDERING ---
        function renderDataTable(data) {
            ui.noDataMessage.classList.toggle('hidden', data.length > 0);
            ui.dataTableBody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                const timestamp = item.timestamp ? new Date(item.timestamp.toMillis()).toLocaleString('es-AR') : 'N/A';
                const mode = item.programmed_params?.Modo || 'N/A';
                const progSum = Object.entries(item.programmed_params || {}).filter(([k]) => k !== 'Modo').map(([k, v]) => `${k}: ${v}`).join(', ');
                const patSum = Object.entries(item.patient_params || {}).map(([k, v]) => `${k}: ${v}`).join(', ');
                row.innerHTML = `
                    <td class="p-3 text-sm text-gray-700">${timestamp}</td>
                    <td class="p-3 text-sm font-semibold text-indigo-600">${mode}</td>
                    <td class="p-3 text-sm text-gray-700 truncate" style="max-width: 200px;">${progSum || 'N/A'}</td>
                    <td class="p-3 text-sm text-gray-700 truncate" style="max-width: 200px;">${patSum || 'N/A'}</td>
                    <td class="p-3 text-sm"><button class="delete-btn text-red-600 hover:text-red-800" data-id='${item.id}'>Borrar</button></td>
                `;
                ui.dataTableBody.appendChild(row);
            });
        }

        function displayExtractedData(data) {
            extractedData = data;
            // Populate "For Evolution" tab
            let evoText = "Paciente en ARM:\n";
            if (data.programmed_params) {
                evoText += "Parámetros programados:\n";
                for (const [key, value] of Object.entries(data.programmed_params)) {
                    evoText += `- ${key}: ${value}\n`;
                }
            }
            if (data.patient_params) {
                evoText += "\nParámetros medidos:\n";
                 for (const [key, value] of Object.entries(data.patient_params)) {
                    evoText += `- ${key}: ${value}\n`;
                }
            }
            ui.evolutionCopyArea.value = evoText;

            // Populate "For Database" tab
            const createParamHTML = (params) => Object.entries(params || {}).map(([key, value]) => `<div class="flex justify-between items-center"><span class="text-gray-600">${key}</span><span class="font-semibold text-gray-800">${value}</span></div>`).join('') || '<p class="text-gray-500">N/A</p>';
            ui.programmedParams.innerHTML = createParamHTML(data.programmed_params);
            ui.patientParams.innerHTML = createParamHTML(data.patient_params);
            
            ui.loader.classList.add('hidden');
            ui.analysisResult.classList.remove('hidden');
        }

        // --- EVENT HANDLERS ---
        ui.saveConfigButton.addEventListener('click', saveConfig);
        ui.uploadButton.addEventListener('click', () => ui.imageUpload.click());
        ui.imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                resetAnalysisState();
                ui.analysisSection.classList.remove('hidden');
                ui.loader.classList.remove('hidden');
                const reader = new FileReader();
                reader.onload = (e) => {
                    ui.imagePreview.src = e.target.result;
                    ui.imagePreviewContainer.classList.remove('hidden');
                    analyzeImage(e.target.result.split(',')[1]);
                };
                reader.readAsDataURL(file);
            }
        });
        ui.tabEvo.addEventListener('click', () => {
            ui.tabEvo.classList.add('active'); ui.tabDb.classList.remove('active');
            ui.contentEvo.classList.remove('hidden'); ui.contentDb.classList.add('hidden');
        });
        ui.tabDb.addEventListener('click', () => {
            ui.tabDb.classList.add('active'); ui.tabEvo.classList.remove('active');
            ui.contentDb.classList.remove('hidden'); ui.contentEvo.classList.add('hidden');
        });
        ui.evolutionCopyArea.addEventListener('click', () => {
            ui.evolutionCopyArea.select();
            document.execCommand('copy');
            ui.copyFeedback.textContent = '¡Copiado!';
            setTimeout(() => ui.copyFeedback.textContent = '', 2000);
        });
        ui.saveButton.addEventListener('click', async () => {
            if (!extractedData || !userId) return;
            ui.saveButton.disabled = true; ui.saveButton.textContent = 'Guardando...';
            try {
                const dataToSave = { ...extractedData, userId, timestamp: serverTimestamp() };
                await addDoc(collection(db, `artifacts/${APP_ID}/public/data/readings`), dataToSave);
                resetAnalysisState();
            } catch (error) { console.error("Error saving data:", error); } 
            finally { ui.saveButton.disabled = false; ui.saveButton.textContent = 'Guardar en Base de Datos'; }
        });
        ui.dataTableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const docId = e.target.dataset.id;
                if (confirm('¿Borrar este registro?')) {
                    await deleteDoc(doc(db, `artifacts/${APP_ID}/public/data/readings`, docId));
                }
            }
        });
        ui.exportCsvButton.addEventListener('click', () => {
            if (allDbData.length === 0) return;
            const flattenedData = allDbData.map(item => {
                const base = { id: item.id, userId: item.userId, timestamp: item.timestamp ? new Date(item.timestamp.toMillis()).toISOString() : '', modo: item.programmed_params?.Modo || '' };
                const flatProgrammed = Object.fromEntries(Object.entries(item.programmed_params || {}).map(([k,v]) => [`prog_${k}`, v]));
                const flatPatient = Object.fromEntries(Object.entries(item.patient_params || {}).map(([k,v]) => [`pac_${k}`, v]));
                return {...base, ...flatProgrammed, ...flatPatient};
            });
            const csv = Papa.unparse(flattenedData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.setAttribute("href", URL.createObjectURL(blob));
            link.setAttribute("download", `kinevent_logger_data_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
        });

        // --- CORE LOGIC & HELPERS ---
        async function analyzeImage(base64ImageData) {
            const prompt = `Sos un kinesiólogo experto analizando la pantalla de un ventilador NeumoVent, probablemente un modelo GraphNet. Extraé los parámetros ventilatorios. Organizalos en dos categorías: "programmed_params" (los seteados por el operador) y "patient_params" (los medidos por el equipo). Devolvé la respuesta únicamente en formato JSON. Las claves posibles para "programmed_params" son: "Modo", "VT" (o "VC"), "PEEP", "FR" (o "f"), "FiO2", "T insp", "Rel I:E", "P control", "P soporte", "Trigger", "Ciclado". Las claves posibles para "patient_params" son: "VTe" (o "VTm"), "VMe", "FR tot", "P pico", "P meseta", "P media", "PEEP tot", "C stat", "Raw". Si un valor no está en la pantalla, no incluyas la clave.`;
            try {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }] }] };
                const apiKey = ""; // Proxied by environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                displayExtractedData(JSON.parse(text));
            } catch (error) {
                console.error("Error analyzing image:", error);
                ui.loader.classList.add('hidden');
                ui.analysisError.classList.remove('hidden');
            }
        }
        function resetAnalysisState() {
            ui.analysisSection.classList.add('hidden');
            ui.analysisResult.classList.add('hidden');
            ui.analysisError.classList.add('hidden');
            ui.loader.classList.add('hidden');
            ui.imagePreviewContainer.classList.add('hidden');
            ui.imageUpload.value = '';
            extractedData = null;
        }

        // --- START THE APP ---
        window.onload = checkConfig;
    </script>
</body>
</html>
